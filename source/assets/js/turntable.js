var game=new Phaser.Game(360,540,Phaser.AUTO,"game");BasicGame={};BasicGame.Boot=function(a){};BasicGame.Boot.prototype={init:function(){game.stage.backgroundColor=document.body.bgColor;this.input.maxPointers=1;this.stage.disableVisibilityChange=true;this.scale.parentIsWindow=true;this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL;this.scale.pageAlignHorizontally=true;this.scale.pageAlignVertically=true},preload:function(){this.load.image("preloaderBar","assets/preloader.png");this.load.image("preloaderbar-bottom","assets/preloader-bottom.png")},create:function(){this.state.start("Preloader")},};BasicGame.Preloader=function(a){this.preloadBar=null;this.ready=false};BasicGame.Preloader.prototype={preload:function(){this.add.sprite(55,250,"preloaderbar-bottom");this.preloadBar=this.add.sprite(58,257,"preloaderBar");this.load.setPreloadSprite(this.preloadBar);this.load.image("turntable",turntableImage);this.load.image("panel","assets/turntable/panel.png");this.load.image("lottery","assets/turntable/start-button1.png");this.load.image("press","assets/turntable/press-button.png");this.load.image("mid-pannel","assets/turntable/mid.png");this.load.image("desc-header","assets/turntable/desc-header.png");this.load.image("desc-body","assets/turntable/desc-body.png");this.load.image("desc-footer","assets/turntable/desc-footer.png")},create:function(){this.preloadBar.cropEnabled=false},update:function(){if(this.ready==false){this.ready=true;this.state.start("Game")}}};BasicGame.Game=function(a){this.add;this.camera;this.cache;this.input;this.load;this.math;this.sound;this.stage;this.time;this.tweens;this.world;this.particles;this.physics;this.rnd;this.ready=true;this.award="";this.costText;this.pointsText;this.gameoverText;this.gameoverGroup;this.descobj;this.remainNum;this.scrollY=false;this.enableScroll};BasicGame.Game.prototype={create:function(){var g=game.add.group();var c=this.cache.getImage("turntable");circleX=game.width/2;circleY=100+c.height/2;this.turntable=g.create(circleX,circleY,"turntable");this.turntable.anchor.setTo(0.5);var f=g.create(circleX-92,circleY-123,"mid-pannel");var d=game.add.button(circleX,circleY,"lottery",this.lottery,this);d.anchor.setTo(0.5);g.add(d);this.remainNum=0;if(isLogin){this.remainNum=freeNum-todayNum}else{if(!isLogin&&!!localStorage){var b=new Date().toLocaleDateString();todayTimes=localStorage.getItem("todayTimes");lastDay=localStorage.getItem("lastDay");if(!lastDay||b!=lastDay){todayTimes=0}this.remainNum=freeNum-todayTimes}}this.costText=game.add.text(game.world.centerX,circleY+65,"",{font:"16px Arial",fill:"#ffffff",align:"center"},g);this.costText.anchor.setTo(0.5);this.showCost();this.add.sprite(0,0,"panel");this.add.text(game.world.centerX,10,"大转盘",{font:"30px Arial",fill:"#000000"}).anchor.setTo(0.5,0);if(isLogin){this.pointsText=this.add.text(260,15,userpoints,{font:"20px Arial",fill:"#000000"})}desc=desc.replace(/###/g,"\n");descText=game.add.text(22,482,desc,{font:"20px Arial",fill:"#000000"});descY=450;game.add.sprite(10,descY,"desc-header");descY+=31;for(i=1;i<=Math.ceil(descText.getLocalBounds().height/9);i++){game.add.sprite(10,descY,"desc-body");descY+=9}game.add.sprite(10,descY,"desc-footer");game.world.bringToTop(descText);if(descText.getLocalBounds().height>40){var a=500+descText.getLocalBounds().height;this.enableScroll=true;game.world.setBounds(0,0,360,a);game.inputEnabled=true;game.input.onDown.add(this.beginScroll,this)}else{this.enableScroll=false}this.gameoverGroup=game.add.group();this.gameoverGroup.visible=false;var e={font:"bold 25px Arial",fill:"#0000FF",align:"center"};this.gameoverText=game.add.text(game.world.centerX,85,"",e,this.gameoverGroup);this.gameoverText.anchor.setTo(0.5)},update:function(){if(this.enableScroll&&game.input.activePointer.isDown){game.camera.y+=this.scrollY-game.input.activePointer.y;this.scrollY=game.input.activePointer.y}},beginScroll:function(){this.scrollY=game.input.activePointer.y},showCost:function(){if(this.remainNum>0){this.costText.setText("免费("+this.remainNum+") ")}else{this.costText.setText("每次"+consumePoints+"积分")}},lottery:function(){if(this.ready){this.gameoverGroup.visible=false;var a=this;ajax({url:"/turntable/lottery",data:{},onSuccess:function(b){var c=JSON.parse(b);if(c.code==0){a.award=c.data.award;a.turn(+c.data.angle)}else{ajaxError(c.code)}},})}},turn:function(c){if(isLogin){if(this.remainNum>0){this.remainNum--;this.showCost()}else{userpoints-=consumePoints;if(userpoints<0){sweetAlert("您的积分不够");return}this.pointsText.setText(userpoints)}}if(!isLogin&&!!localStorage){var b=new Date().toLocaleDateString();todayTimes=localStorage.getItem("todayTimes");lastDay=localStorage.getItem("lastDay");if(!lastDay||b!=lastDay){todayTimes=0}if(todayTimes>=freeNum){sweetAlert("请登录");return}localStorage.setItem("todayTimes",++todayTimes);localStorage.setItem("lastDay",b);if(this.remainNum>0){this.remainNum--;this.showCost()}}this.ready=false;this.turntable.angle=0;var e=this.rnd.integerInRange(3,8);var d=this.rnd.integerInRange(2000,3000);
c=360*e-c;var a=game.add.tween(this.turntable).to({angle:c},d,Phaser.Easing.Circular.Out,true);a.onComplete.add(this.endlottery,this)},endlottery:function(){this.ready=true;if(this.award==""){var a="很遗憾，未中奖"}else{var a="恭喜，中了"+this.award+"！"}this.gameoverText.setText(a);this.gameoverGroup.visible=true},};game.state.add("Boot",BasicGame.Boot);game.state.add("Preloader",BasicGame.Preloader);game.state.add("Game",BasicGame.Game);game.state.start("Boot");
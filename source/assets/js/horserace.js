!function(){var game=new Phaser.Game(360,540,Phaser.AUTO,"game"),horseNum=8;BasicGame={},BasicGame.Boot=function(){},BasicGame.Boot.prototype={init:function(){game.stage.backgroundColor=document.body.bgColor,window.innerWidth?(winWidth=window.innerWidth,winHeight=window.innerHeight):document.body&&document.body.clientWidth?(winWidth=document.body.clientWidth,winHeight=document.body.clientHeight):document.documentElement&&document.documentElement.clientHeight&&document.documentElement.clientWidth&&(winHeight=document.documentElement.clientHeight,winWidth=document.documentElement.clientWidth),this.input.maxPointers=1,this.scale.parentIsWindow=!0,this.scale.scaleMode=winHeight/winWidth>1.3&&1.7>winHeight/winWidth?Phaser.ScaleManager.EXACT_FIT:Phaser.ScaleManager.SHOW_ALL,this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0},preload:function(){this.load.image("preloaderBar","assets/preloader.png"),this.load.image("preloaderbar-bottom","assets/preloader-bottom.png")},create:function(){this.state.start("Preloader")}},BasicGame.Preloader=function(){this.preloadBar=null,this.ready=!1},BasicGame.Preloader.prototype={preload:function(){for(this.add.sprite(55,250,"preloaderbar-bottom"),this.preloadBar=this.add.sprite(58,257,"preloaderBar"),this.load.setPreloadSprite(this.preloadBar),this.load.image("menu-bg","assets/horserace/bg.jpg"),this.load.image("start","assets/horserace/start.png"),this.load.image("back","assets/horserace/back.png"),this.load.image("confirm","assets/horserace/confirm.png"),this.load.image("popup","assets/horserace/popup.png"),this.load.spritesheet("rank","assets/horserace/rank.png",24,24),this.load.image("add","assets/horserace/add.png"),this.load.image("sub","assets/horserace/sub.png"),this.load.image("gameover","assets/horserace/gameover.png"),this.load.image("light","assets/horserace/light.png"),i=0;horseNum>i;i++)hid=i+1,this.load.spritesheet("horse"+hid,"assets/horserace/"+hid+".png",130,60);this.load.image("runway-begin","assets/horserace/begin.png"),this.load.image("runway","assets/horserace/runway.png"),this.load.image("runway-end","assets/horserace/end.png"),this.load.image("panel","assets/horserace/panel.png"),this.load.spritesheet("stand","assets/horserace/stand.png",87,55),this.load.image("gamepoints","assets/gamepoints.png"),this.load.audio("race-sound","assets/horserace/race.mp3")},create:function(){this.preloadBar.cropEnabled=!1,this.state.start("MainMenu")}},myChips={},myChips.rank=[0,0,0],myChips.rankPoints=[0,0,0],BasicGame.MainMenu=function(){this.music=null,this.selectedHorse=null,this.betPoints=null,this.popup,this.rankButton=[],this.rankSprite=[],this.selectedRank=null,this.oldSelectedRank=null,this.ready=!1,this.isPopup=!1,this.pointsText},BasicGame.MainMenu.prototype={init:function(){if(this.selectedHorse&&this.selectedHorse.destroy(),this.betPoints&&this.betPoints.destroy(),this.popup&&this.popup.destroy(),this.rankButton=[],this.rankSprite.length>0)for(i=0;i<this.rankSprite.length;i++)this.rankSprite[i].destroy();this.started=!1,this.ready=!1,this.selectedRank=null,this.oldSelectedRank=null,myChips.rank=[0,0,0],myChips.rankPoints=[0,0,0]},create:function(){var a,b,c,d;for(game.world.setBounds(0,0,360,540),this.add.sprite(0,0,"menu-bg"),a=this.add.group(),a.create(0,50,"gamepoints"),this.pointsText=this.add.text(45,50,userpoints,{font:"20px Arial",fill:"#00CC00"},a),a.x=(game.world.width-a.width)/2,b=59,c=90,i=0;horseNum>i;i++)d=this.add.sprite(b,c,"stand",i),d.inputEnabled=!0,d.events.onInputDown.add(this.bet,this),0==i%2?b+=155:(b-=155,c+=100);for(this.popup=this.add.group(),this.popup.create(game.world.centerX,game.world.centerY,"popup").anchor.setTo(.5),this.selectedHorse=this.add.text(132,161,"",{font:"20px Arial",fill:"#ffffff"},this.popup),this.popup.visible=!1,rankButtonX=112,i=0;3>i;i++)this.rankButton[i]=this.popup.create(rankButtonX,210,"rank",3+i),this.rankButton[i].inputEnabled=!0,this.rankButton[i].events.onInputDown.add(this.toggleRank,this),this.rankButton[i].rankId=i,rankButtonX+=54;for(this.add.button(game.world.centerX,375,"confirm",this.closePopup,this,null,null,null,null,this.popup).anchor.setTo(.5),this.add.button(55,315,"sub",this.subPoints,this,null,null,null,null,this.popup).anchor.setTo(.5),this.add.button(305,315,"add",this.addPoints,this,null,null,null,null,this.popup).anchor.setTo(.5),this.betPoints=this.add.text(150,300,chip,{font:"30px Arial",fill:"#000000"},this.popup),i=0;3>i;i++)this.rankSprite[i]=this.add.group();this.add.button(game.world.centerX,495,"start",this.startGame,this).anchor.setTo(.5,0)},update:function(){},bet:function(a){if(!this.isPopup){this.selectedRank=this.oldSelectedRank=null,this.isPopup=!0;var b=a.frame+1;for(this.selectedHorse.setText(b),this.betPoints.setText(chip),i=0;3>i;i++)if(myChips.rank[i]==b){this.rankButton[i].loadTexture("rank",i),this.selectedRank=this.oldSelectedRank=i+1,this.betPoints.setText(myChips.rankPoints[i]);break}game.world.bringToTop(this.popup),this.popup.visible=!0}},closePopup:function(){var a,b,c,d,e;this.popup.visible=!1,a=+this.betPoints.text,b=+this.selectedHorse.text,c=0,this.oldSelectedRank&&(this.oldSelectedRank==this.selectedRank&&a||(myChips.rank[this.oldSelectedRank-1]=0,this.rankSprite[this.oldSelectedRank-1].visible=!1),c+=myChips.rankPoints[this.oldSelectedRank-1]),this.selectedRank&&(this.rankButton[this.selectedRank-1].loadTexture("rank",this.selectedRank+2),a&&(this.selectedRank--,myChips.rank[this.selectedRank]=b,myChips.rankPoints[this.selectedRank]=a,c-=a,d=55+155*((b-1)%2),e=155+100*parseInt((b-1)/2),0==this.rankSprite[this.selectedRank].length?(this.rankSprite[this.selectedRank].create(0,0,"rank",this.selectedRank),this.add.text(40,0,a,{font:"20px Arial",fill:"#00CC00"},this.rankSprite[this.selectedRank]),this.rankSprite[this.selectedRank].x=d,this.rankSprite[this.selectedRank].y=e):(this.rankSprite[this.selectedRank].x=d,this.rankSprite[this.selectedRank].y=e,this.rankSprite[this.selectedRank].getAt(1).setText(a),this.rankSprite[this.selectedRank].visible=!0))),this.updPoints(c),this.isPopup=!1},toggleRank:function(a){var d,b=+this.selectedHorse.text,c=a.rankId;this.selectedRank&&this.selectedRank==c+1?(a.loadTexture("rank",c+3),this.selectedRank=null):myChips.rank[c]&&myChips.rank[c]!=b?(d=this,sweetAlert({title:"确定要重新下注第"+(c+1)+"名吗?",text:"确定将会取消前次下注"+myChips.rank[c]+"号马为第"+(c+1)+"名!",type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonColor:"#DD6B55",confirmButtonText:"确定",closeOnConfirm:!0},function(){myChips.rank[c]=0,d.updPoints(myChips.rankPoints[c]),d.rankSprite[a.rankId].visible=!1,d.selectRank(a)})):this.selectRank(a)},updPoints:function(a){0!=a&&(userpoints+=a,this.pointsText.setText(userpoints))},selectRank:function(a){this.selectedRank&&this.rankButton[this.selectedRank-1].loadTexture("rank",this.selectedRank+2),a.loadTexture("rank",a.rankId),this.selectedRank=a.rankId+1},addPoints:function(){return chip>userpoints?(sweetAlert("您的积分不够"),void 0):(this.betPoints.setText(+this.betPoints.text+chip),void 0)},subPoints:function(){var a=+this.betPoints.text;a>=chip?this.betPoints.setText(a-chip):a>0&&this.betPoints.setText(0)},startGame:function(){var a,b;if(!this.isPopup&&!this.started){for(a=0,i=0;i<myChips.rank.length;i++)myChips.rank[i]>0&&myChips.rankPoints[i]>0?(this.ready=!0,a+=myChips.rankPoints[i]):0==myChips.rank[i]&&myChips.rankPoints[i]>0&&(myChips.rankPoints[i]=0);return this.ready?(b=this,this.started=!0,ajax({url:"/horserace/start",data:myChips,onSuccess:function(c){var d=JSON.parse(c);0==d.code?b.state.start("Game",!0,!1,d.data.rank):(b.updPoints(a),ajaxError(d.code))}}),void 0):(sweetAlert("请先下注"),void 0)}}},BasicGame.Game=function(){this.ranklist,this.players=[],this.panel,this.runwayLength=1080,this.runLength=900,this.startX=0,this.horsePadding=10},BasicGame.Game.prototype={init:function(a){this.ranklist=a},create:function(){var a,b;for(game.world.setBounds(0,0,this.runwayLength,540),game.add.tileSprite(0,0,game.world.width,game.height,"runway"),game.add.sprite(50+this.startX,108,"runway-begin"),game.add.sprite(this.startX+this.runLength+130-this.horsePadding,108,"runway-end"),this.panel=game.add.group(),this.panel.create(0,0,"panel"),this.panel.fixedToCamera=!0,this.panel.cameraOffset.x=0,this.panel.cameraOffset.y=0,a=3,myChips["rank"][0]?game.add.text(80,a,myChips["rank"][0]+"号  下注积分："+myChips["rankPoints"][0],{font:"20px Arial",fill:"#00CC00"},this.panel):game.add.text(150,a,"未下注",{font:"20px Arial",fill:"#FF0000"},this.panel),a+=30,myChips["rank"][1]?game.add.text(80,a,myChips["rank"][1]+"号  下注积分："+myChips["rankPoints"][1],{font:"20px Arial",fill:"#00CC00"},this.panel):game.add.text(150,a,"未下注",{font:"20px Arial",fill:"#FF0000"},this.panel),a+=30,myChips["rank"][2]?game.add.text(80,a,myChips["rank"][2]+"号  下注积分："+myChips["rankPoints"][2],{font:"20px Arial",fill:"#00CC00"},this.panel):game.add.text(150,a,"未下注",{font:"20px Arial",fill:"#FF0000"},this.panel),b=95,i=0;horseNum>i;i++)this.players[i]=game.add.sprite(this.startX,b+53*(this.ranklist[i]-1),"horse"+this.ranklist[i],0);this.raceSound=this.add.sound("race-sound",1,!0),this.runStart()},runStart:function(){var b,c,d,a=this.rndDuration(7e3,12e3);for(cameraMoveTime=a[0],b=this.runLength/4,c=[],tweenLimit=4,i=0;horseNum>i;i++){for(section=this.rndSection(a[i],this.runLength,tweenLimit),d=game.add.tween(this.players[i]).to({x:this.startX+b},section[0],Phaser.Easing.Linear.None),tweenI=1;tweenLimit>tweenI;tweenI++)d.to({x:this.startX+b*(tweenI+1)},section[tweenI],Phaser.Easing.Linear.None);7==i?(d.chain(game.add.tween(this.players[i]).to({x:game.world.width},2e3,Phaser.Easing.Linear.None)),d.onComplete.add(function(){this.raceSound.fadeOut(1500),game.time.events.add(1e3,this.gameover,this)},this),c[i]=d):(d.to({x:game.world.width},2e3,Phaser.Easing.Linear.None),c[i]=d)}for(i=0;horseNum>i;i++)this.players[i].animations.add("run"),this.players[i].animations.play("run",12,!0),c[i].start();this.raceSound.play(),game.add.tween(game.camera).to({x:720},cameraMoveTime,Phaser.Easing.Linear.None,!0)},gameover:function(){var b,a=game.add.graphics(0,0);a.alpha=.7,a.beginFill(0),a.drawRect(this.runwayLength-360,0,360,540),game.world.bringToTop(a),a.endFill(),b=this.add.group(),b.create(this.runwayLength-175,game.world.centerY,"gameover").anchor.setTo(.5),this.ranklist[1]==myChips.rank[1]&&b.create(this.runwayLength-330,game.world.centerY-125,"light"),this.ranklist[0]==myChips.rank[0]&&b.create(this.runwayLength-240,game.world.centerY-160,"light"),this.ranklist[2]==myChips.rank[2]&&b.create(this.runwayLength-160,game.world.centerY-110,"light"),b.create(this.runwayLength-300,game.world.centerY-80,"stand",this.ranklist[1]-1),b.create(this.runwayLength-210,game.world.centerY-110,"stand",this.ranklist[0]-1),b.create(this.runwayLength-130,game.world.centerY-60,"stand",this.ranklist[2]-1),this.add.button(this.runwayLength-245,game.world.centerY+100,"back",function(){this.state.start("MainMenu")},this)},update:function(){},rndDuration:function(a,b){var e,f,g,c=this.rnd.integerInRange(a,b),d=[];for(e=0;horseNum>e;e++){f=0;do{for(g=0;g<d.length;g++)if(d[g]==c){f=1;break}f?c=this.rnd.integerInRange(a,b):d[d.length]=c}while(!f)}return d.sort(function(a,b){return a-b}),d},rndSection:function(duration,distance,limit){var sum,t=duration/4,intT=parseInt(t),minT=parseInt(.8*t),maxT=parseInt(1.2*t),tArray=[],avg=distance/duration;for(k=0;limit>k;k++)k==limit-1?tArray[tArray.length]=duration-eval(tArray.join("+")):3==k?(sum=eval(tArray.join("+")),tArray[tArray.length]=sum/tArray.length>avg?this.rnd.integerInRange(minT,intT):sum/tArray.length<avg?this.rnd.integerInRange(intT,maxT):this.rnd.integerInRange(minT,maxT)):tArray[tArray.length]=this.rnd.integerInRange(minT,maxT);return tArray}},game.state.add("Boot",BasicGame.Boot),game.state.add("Preloader",BasicGame.Preloader),game.state.add("MainMenu",BasicGame.MainMenu),game.state.add("Game",BasicGame.Game),game.state.start("Boot")}();
function matrix(c,d,e){this.base={w:30,h:30};this.mw=c/this.base.w;this.mh=d/this.base.h;this.mt=[];for(i=0;i<this.mw;i++){this.mt[i]=[];for(j=0;j<this.mh;j++){this.mt[i][j]={filled:false}}}for(k=0;k<e.length;k++){point=this.mscan(e[k]);if(point){e[k].x=point.x*this.base.w;e[k].y=point.y*this.base.h+40;e[k].active=true}else{e[k].active=false}}}matrix.prototype={checkFill:function(e,d,f,c){for(m=0;m<f;m++){for(n=0;n<c;n++){if(this.mt[e+m][d+n].filled){return{x:e+m,y:d+n,find:false}}}}return{find:true}},mscan:function(d){var e=d.w/this.base.w;var c=d.h/this.base.h;limitX=-1;limitY=-1;for(j=0;j<this.mh-c+1;j++){for(i=0;i<this.mw-e+1;i++){if(i<=limitX&&j<=limitY){continue}res=this.checkFill(i,j,e,c);if(res.find){for(a=i;a<i+e;a++){for(b=j;b<j+c;b++){this.mt[a][b].filled=true}}return{x:i,y:j}}else{limitX=res.x;limitY=res.y}}}}};var game=new Phaser.Game(360,540,Phaser.AUTO,"game");BasicGame={tags:[],imageTags:[]};BasicGame.Boot=function(c){};BasicGame.Boot.prototype={init:function(){game.stage.backgroundColor="#ffffff";this.input.maxPointers=1;this.stage.disableVisibilityChange=true;this.scale.parentIsWindow=true;this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL;this.scale.pageAlignHorizontally=true;this.scale.pageAlignVertically=true},preload:function(){this.load.image("preloaderBar","assets/preloader.png");this.load.image("preloaderbar-bottom","assets/preloader-bottom.png");this.load.json("sconfig","/find/config")},create:function(){this.state.start("Preloader")},};BasicGame.Preloader=function(c){this.preloadBar=null;this.ready=false};BasicGame.Preloader.prototype={preload:function(){this.add.sprite(55,250,"preloaderbar-bottom");this.preloadBar=this.add.sprite(58,257,"preloaderBar");this.load.setPreloadSprite(this.preloadBar);this.load.image("menu-header","assets/find/menu-header.png");this.load.image("menu-mid","assets/find/menu-mid.png");this.load.image("menu-footer","assets/find/menu-footer.png");this.load.image("start","assets/find/start.png");this.load.image("header","assets/find/header.png");this.load.image("footer","assets/find/footer.png");this.load.image("prompt","assets/find/prompt.png");this.load.image("add-time","assets/find/add-time.png");this.load.image("gamepoints","assets/gamepoints.png");var f=this.cache.getJSON("sconfig").data.images;BasicGame.tags=this.cache.getJSON("sconfig").data.tags;if(!f||f.length<=0){sweetAlert("请检查网络");return}var c=f.length;for(var e=0;e<c;e++){var d=f.splice(Math.floor(Math.random()*f.length),1);d=d[0];this.load.image("image"+e,"assets/find/images/"+d.file_name);BasicGame.imageTags[e]=d.tags.split(",")}this.ready=true},create:function(){if(this.ready){this.preloadBar.cropEnabled=false;this.state.start("MainMenu")}},};BasicGame.MainMenu=function(c){this.music=null;this.playButton=null;this.scrollY;this.enableScroll};BasicGame.MainMenu.prototype={create:function(){this.add.sprite(0,0,"menu-header");var e=this.add.group();e.create(0,100,"gamepoints");this.pointsText=this.add.text(45,100,userpoints,{font:"20px Arial",fill:"#ffffff"},e);e.x=(game.world.width-e.width)/2;var d=this.cache.getJSON("sconfig").data.desc;descText=game.add.text(40,160,d,{font:"20px Arial",fill:"#000000"});var c=0;descY=280;if(descText.getLocalBounds().height>250){this.enableScroll=true;for(i=1;i<=Math.ceil((descText.getLocalBounds().height-250)/20);i++){game.add.sprite(0,descY,"menu-mid");descY+=20;c++}}else{this.enableScroll=false}game.add.sprite(0,descY,"menu-footer");game.world.bringToTop(descText);if(this.enableScroll){game.world.setBounds(0,0,360,540+20*c);game.inputEnabled=true;game.input.onDown.add(this.beginScroll,this)}this.add.button(game.world.centerX,descY+170,"start",this.startGame,this).anchor.setTo(0.5,0)},update:function(){if(this.enableScroll&&game.input.activePointer.isDown){game.camera.y+=this.scrollY-game.input.activePointer.y;this.scrollY=game.input.activePointer.y}},beginScroll:function(){this.scrollY=game.input.activePointer.y},startGame:function(){this.state.start("Game")}};BasicGame.Game=function(c){this.ready=false;this.scrollY=false};BasicGame.Game.prototype={init:function(){this.activeImages=[];this.deathImages=[];this.currentLevel=0;this.currentTag="";this.promptTimes=0;this.taskNum=0;this.found=[];this.addtTimes=0;this.currentId=0;this.currentId=0;this.ready=false;this.addPointsText=null;this.findHeight=810;this.sconfig=this.cache.getJSON("sconfig");this.sconfig=this.sconfig.data;this.remainTime=parseInt(this.sconfig.i);this.sconfig.fr=parseInt(this.sconfig.fr);this.sconfig.rp=parseInt(this.sconfig.rp);this.sconfig.mr=parseInt(this.sconfig.mr);this.sconfig.at=parseInt(this.sconfig.at);this.sconfig.st=parseInt(this.sconfig.st);this.sconfig.t=parseInt(this.sconfig.t);this.sconfig.tp=parseInt(this.sconfig.tp);this.sconfig.mt=parseInt(this.sconfig.mt);this.sconfig.prizeLevel=parseInt(this.sconfig.pl)},create:function(){imgs=[];for(var f=0;f<BasicGame.imageTags.length;f++){imgs.push({w:this.cache.getImage("image"+f).width,h:this.cache.getImage("image"+f).height})}game.world.setBounds(0,0,360,this.findHeight+90);
game.inputEnabled=true;game.input.onDown.add(this.beginScroll,this);var e=new matrix(360,this.findHeight,imgs);for(var f=0;f<imgs.length;f++){var d=imgs[f];if(d.active){var g=this.add.sprite(d.x,d.y,"image"+f);g.imgIndex=f;g.inputEnabled=true;g.events.onInputDown.add(this.checkBegin,this);g.events.onInputUp.add(this.check,this);this.activeImages.push(g)}else{d.imgIndex=f;this.deathImages.push(d)}}this.uiframe=this.add.group();this.uiframe.create(0,0,"header");this.uiframe.create(0,491,"footer");this.uiframe.fixedToCamera=true;this.uiframe.add(this.add.button(10,503,"prompt",this.promptOnce,this));this.uiframe.add(this.add.button(102,503,"add-time",this.addTime,this));this.promptText=this.add.text(54,506,this.sconfig.fr,{font:"15px Arial",fill:"#ffffff"});this.levelText=this.add.text(305,22,"",{font:"20px Arial",fill:"#ffffff"});this.levelText.anchor.setTo(0.5);this.taskText=this.add.text(20,22,"",{font:"20px Arial",fill:"#000000"});this.taskText.anchor.setTo(0,0.5);this.uiframe.add(this.promptText);this.uiframe.add(this.levelText);this.uiframe.add(this.taskText);this.timeText=this.add.text(300,503,this.getRTime(),{font:"21px Arial",fill:"#000000"});this.remainTimer=game.time.events.loop(Phaser.Timer.SECOND,this.updateTime,this);this.uiframe.add(this.timeText);var c=this;ajax({url:"/find/begin",data:{},onSuccess:function(h){var l=JSON.parse(h);if(l.code==0){c.currentId=l.data.i;c.ready=true;c.nextLevel()}else{ajaxError(l.code)}},})},nextLevel:function(){this.currentLevel++;this.found=[];var d=this.rnd.integerInRange(0,this.activeImages.length-1);var c=this.rnd.integerInRange(0,BasicGame.imageTags[this.activeImages[d].imgIndex].length-1);this.currentTag=BasicGame.imageTags[this.activeImages[d].imgIndex][c];var f=0;for(i=0;i<this.activeImages.length;i++){if(inArray(this.currentTag,BasicGame.imageTags[this.activeImages[i].imgIndex])){f++}}var e=this.math.floor(f/2);if(e==0){e=1}this.taskNum=this.rnd.integerInRange(e,f);if(this.taskNum>7){this.taskNum=7}this.levelText.setText("第 "+this.currentLevel+" 关");this.taskText.setText(BasicGame.tags[this.currentTag]+" × "+this.taskNum)},findOne:function(e){this.found.push(e.imgIndex);this.add.tween(e).to({alpha:0},500,Phaser.Easing.Linear.None,true).onComplete.add(function(){var h=null;var l=false;for(var g=0;g<this.deathImages.length;g++){if(this.deathImages[g].w==e.width&&this.deathImages[g].h==e.height){if(inArray(this.currentTag,BasicGame.imageTags[this.deathImages[g].imgIndex])){if(!h){h=g}continue}l=true;e.loadTexture("image"+this.deathImages[g].imgIndex);this.add.tween(e).to({alpha:1},500,Phaser.Easing.Linear.None,true);var f={w:e.width,h:e.height,imgIndex:e.imgIndex};e.imgIndex=this.deathImages[g].imgIndex;this.deathImages.splice(g,1);this.deathImages.push(f);break}}if(!l&&h!=null){e.loadTexture("image"+this.deathImages[h].imgIndex);this.add.tween(e).to({alpha:1},500,Phaser.Easing.Linear.None,true);var f={w:e.width,h:e.height,imgIndex:e.imgIndex};e.imgIndex=this.deathImages[h].imgIndex;this.deathImages.splice(h,1);this.deathImages.push(f)}else{if(!l){this.add.tween(e).to({alpha:1},500,Phaser.Easing.Linear.None,true)}}},this);if(this.found.length<this.taskNum){this.taskText.setText(BasicGame.tags[this.currentTag]+" × "+(this.taskNum-this.found.length));return}if(inArray(this.currentLevel,this.sconfig.prizeLevel)){var d=false;var c=this;ajax({url:"/find/finish",data:{i:this.currentId,level:this.currentLevel},onSuccess:function(f){var g=JSON.parse(f);if(g.code==0){if(g.data&&g.data.points){c.showPoints("奖励"+g.data.points+"积分")}c.nextLevel()}else{ajaxError(g.code)}},});return}this.nextLevel()},showPoints:function(d){if(!this.addPointsText){this.addPointsText=this.add.text(game.world.centerX,22,d,{font:"25px Arial",fill:"#3DA3EF"});this.addPointsText.anchor.setTo(0.5);this.addPointsText.alpha=0}else{this.addPointsText.setText(d);game.world.bringToTop(this.addPointsText)}var c=game.add.tween(this.addPointsText).to({alpha:1},1000,Phaser.Easing.Linear.None);c.to({alpha:0},500,Phaser.Easing.Linear.None);c.start()},checkBegin:function(c,d){c.lastClick=game.time.now},check:function(c,d){if(!this.ready||game.time.now-c.lastClick>400){return}if(inArray(c.imgIndex,this.found)){return}if(inArray(this.currentTag,BasicGame.imageTags[c.imgIndex])){this.remainTime+=this.sconfig.at;this.findOne(c);return}this.remainTime-=this.sconfig.st},topHeadFoot:function(){game.world.bringToTop(this.header);game.world.bringToTop(this.footer)},getRTime:function(){minutes=Math.floor(this.remainTime/60);seconds=this.remainTime%60;if(minutes<10){minutes="0"+minutes}if(seconds<10){seconds="0"+seconds}return minutes+":"+seconds},updateTime:function(){if(!this.ready){return}this.remainTime--;if(this.remainTime<=0){game.time.events.remove(this.remainTimer);this.timeText.setText("00:00");this.ready=false;var d=false;var c=this;sweetAlert({title:"时间到！"},function(){d=true;c.state.start("MainMenu")});game.time.events.add(Phaser.Timer.SECOND*5,function(){if(!d){this.state.start("MainMenu")}},this).autoDestroy=true
}else{this.timeText.setText(this.getRTime())}},promptOnce:function(){if(!this.ready){return}if(this.promptTimes>=this.sconfig.fr+this.sconfig.mr){sweetAlert("每轮最多购买"+this.sconfig.mr+"次提醒")}else{if(this.promptTimes>=this.sconfig.fr){if(userpoints<this.sconfig.rp){sweetAlert("您的积分不够");return}else{var c=this;ajax({url:"/find/prompt",data:{i:this.currentId},onSuccess:function(d){var e=JSON.parse(d);if(e.code==0){userpoints-=c.sconfig.rp;if(c.found.length<c.taskNum){c.showPoints("-"+c.sconfig.rp)}c.doPrompt()}else{ajaxError(e.code)}},})}}else{this.promptText.setText(this.sconfig.fr-this.promptTimes-1);this.doPrompt()}}},doPrompt:function(){if(Math.random()>0.5){for(var c=0;c<this.activeImages.length;c++){if(inArray(this.currentTag,BasicGame.imageTags[this.activeImages[c].imgIndex])){this.promptTimes++;if(this.activeImages[c].y>game.camera.y+400){game.camera.y=this.activeImages[c].y-400+this.activeImages[c].height+this.rnd.integerInRange(0,(this.findHeight-180)/2)}else{if(this.activeImages[c].y<game.camera.y+40){game.camera.y=this.activeImages[c].y-40-this.rnd.integerInRange(0,(this.findHeight-180)/2)}}this.findOne(this.activeImages[c]);return}}}else{for(var c=this.activeImages.length-1;c>=0;c--){if(inArray(this.currentTag,BasicGame.imageTags[this.activeImages[c].imgIndex])){this.promptTimes++;if(this.activeImages[c].y>game.camera.y+400){game.camera.y=this.activeImages[c].y-400+this.activeImages[c].height+this.rnd.integerInRange(0,(this.findHeight-180)/2)}else{if(this.activeImages[c].y<game.camera.y+40){game.camera.y=this.activeImages[c].y-40-this.rnd.integerInRange(0,(this.findHeight-180)/2)}}this.findOne(this.activeImages[c]);return}}}},addTime:function(){if(!this.ready){return}if(this.addtTimes>=this.sconfig.mt){sweetAlert("每轮最多加时"+this.sconfig.mt+"次")}else{if(userpoints<this.sconfig.t){sweetAlert("您的积分不够");return}else{var c=this;ajax({url:"/find/timer",data:{i:this.currentId},onSuccess:function(d){var e=JSON.parse(d);if(e.code==0){userpoints-=c.sconfig.tp;c.remainTime+=c.sconfig.t;c.showPoints("-"+c.sconfig.tp);c.addtTimes++}else{ajaxError(e.code)}},})}}},update:function(){if(this.ready&&game.input.activePointer.isDown){game.camera.y+=this.scrollY-game.input.activePointer.y;this.scrollY=game.input.activePointer.y}},beginScroll:function(){this.scrollY=game.input.activePointer.y},};game.state.add("Boot",BasicGame.Boot);game.state.add("Preloader",BasicGame.Preloader);game.state.add("MainMenu",BasicGame.MainMenu);game.state.add("Game",BasicGame.Game);game.state.start("Boot");
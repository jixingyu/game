!function(){function c(a,b,c){for(this.base={w:30,h:30},this.mw=a/this.base.w,this.mh=b/this.base.h,this.mt=[],i=0;i<this.mw;i++)for(this.mt[i]=[],j=0;j<this.mh;j++)this.mt[i][j]={filled:!1};for(k=0;k<c.length;k++)point=this.mscan(c[k]),point?(c[k].x=point.x*this.base.w,c[k].y=point.y*this.base.h+40,c[k].active=!0):c[k].active=!1}c.prototype={checkFill:function(a,b,c,d){for(m=0;c>m;m++)for(n=0;d>n;n++)if(this.mt[a+m][b+n].filled)return{x:a+m,y:b+n,find:!1};return{find:!0}},mscan:function(c){var d=c.w/this.base.w,e=c.h/this.base.h;for(limitX=-1,limitY=-1,j=0;j<this.mh-e+1;j++)for(i=0;i<this.mw-d+1;i++)if(!(limitX>=i&&limitY>=j)){if(res=this.checkFill(i,j,d,e),res.find){for(a=i;i+d>a;a++)for(b=j;j+e>b;b++)this.mt[a][b].filled=!0;return{x:i,y:j}}limitX=res.x,limitY=res.y}}};var d=new Phaser.Game(360,540,Phaser.AUTO,"game");BasicGame={tags:[],imageTags:[]},BasicGame.Boot=function(){},BasicGame.Boot.prototype={init:function(){d.stage.backgroundColor="#ffffff",this.input.maxPointers=1,this.scale.parentIsWindow=!0,this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0},preload:function(){this.load.image("preloaderBar","assets/preloader.png"),this.load.image("preloaderbar-bottom","assets/preloader-bottom.png"),this.load.json("sconfig","/find/config")},create:function(){this.state.start("Preloader")}},BasicGame.Preloader=function(){this.preloadBar=null,this.ready=!1},BasicGame.Preloader.prototype={preload:function(){var a,b,c,d;if(this.add.sprite(55,250,"preloaderbar-bottom"),this.preloadBar=this.add.sprite(58,257,"preloaderBar"),this.load.setPreloadSprite(this.preloadBar),this.load.image("menu-header","assets/find/menu-header.png"),this.load.image("menu-mid","assets/find/menu-mid.png"),this.load.image("menu-footer","assets/find/menu-footer.png"),this.load.image("start","assets/find/start.png"),this.load.image("header","assets/find/header.png"),this.load.image("footer","assets/find/footer.png"),this.load.image("prompt","assets/find/prompt.png"),this.load.image("prompt-times","assets/find/prompt-times.png"),this.load.image("add-time","assets/find/add-time.png"),this.load.image("gamepoints","assets/gamepoints.png"),a=this.cache.getJSON("sconfig").data.images,BasicGame.tags=this.cache.getJSON("sconfig").data.tags,!a||a.length<=0)return sweetAlert("请检查网络"),void 0;for(b=a.length,c=0;b>c;c++)d=a.splice(Math.floor(Math.random()*a.length),1),d=d[0],this.load.image("image"+c,"assets/find/images/"+d.file_name),BasicGame.imageTags[c]=d.tags.split(",");this.load.audio("sound-bg","assets/spot/bg.mp3"),this.ready=!0},create:function(){this.ready&&(this.preloadBar.cropEnabled=!1,this.state.start("MainMenu"))}},BasicGame.MainMenu=function(){this.music=null,this.playButton=null,this.scrollY,this.enableScroll,this.soundBg=null},BasicGame.MainMenu.prototype={create:function(){var a,b,c;if(d.world.setBounds(0,0,360,540),this.add.sprite(0,0,"menu-header"),a=this.add.group(),a.create(0,100,"gamepoints"),this.pointsText=this.add.text(45,100,userpoints,{font:"20px Arial",fill:"#ffffff"},a),a.x=(d.world.width-a.width)/2,b=this.cache.getJSON("sconfig").data.desc,descText=d.add.text(40,160,b,{font:"20px Arial",fill:"#000000"}),c=0,descY=280,descText.getLocalBounds().height>250)for(this.enableScroll=!0,i=1;i<=Math.ceil((descText.getLocalBounds().height-250)/20);i++)d.add.sprite(0,descY,"menu-mid"),descY+=20,c++;else this.enableScroll=!1;d.add.sprite(0,descY,"menu-footer"),d.world.bringToTop(descText),this.enableScroll&&(d.world.setBounds(0,0,360,540+20*c),d.inputEnabled=!0,d.input.onDown.add(this.beginScroll,this)),this.add.button(d.world.centerX,descY+170,"start",this.startGame,this).anchor.setTo(.5,0),this.soundBg||(this.soundBg=this.add.sound("sound-bg",1,!0),this.soundBg.play())},update:function(){this.enableScroll&&d.input.activePointer.isDown&&(d.camera.y+=this.scrollY-d.input.activePointer.y,this.scrollY=d.input.activePointer.y)},beginScroll:function(){this.scrollY=d.input.activePointer.y},startGame:function(){this.state.start("Game")}},BasicGame.Game=function(){this.ready=!1,this.scrollX=!1},BasicGame.Game.prototype={init:function(){this.activeImages=[],this.deathImages=[],this.currentLevel=0,this.currentTag="",this.promptTimes=0,this.taskNum=0,this.found=[],this.addtTimes=0,this.currentId=0,this.currentId=0,this.ready=!1,this.promptIng=!1,this.addTimeIng=!1,this.addPointsText=null,this.findWidth=720,this.sconfig=this.cache.getJSON("sconfig"),this.sconfig=this.sconfig.data,this.remainTime=parseInt(this.sconfig.i),this.sconfig.fr=parseInt(this.sconfig.fr),this.sconfig.rp=parseInt(this.sconfig.rp),this.sconfig.mr=parseInt(this.sconfig.mr),this.sconfig.at=parseInt(this.sconfig.at),this.sconfig.st=parseInt(this.sconfig.st),this.sconfig.t=parseInt(this.sconfig.t),this.sconfig.tp=parseInt(this.sconfig.tp),this.sconfig.mt=parseInt(this.sconfig.mt),this.sconfig.prizeLevel=parseInt(this.sconfig.pl)},create:function(){var a,e,f,g,h;for(imgs=[],a=0;a<BasicGame.imageTags.length;a++)imgs.push({w:this.cache.getImage("image"+a).width,h:this.cache.getImage("image"+a).height});for(d.world.setBounds(0,0,this.findWidth,540),d.inputEnabled=!0,d.input.onDown.add(this.beginScroll,this),new c(this.findWidth,450,imgs),a=0;a<imgs.length;a++)e=imgs[a],e.active?(f=this.add.sprite(e.x,e.y,"image"+a),f.imgIndex=a,f.inputEnabled=!0,f.events.onInputDown.add(this.checkBegin,this),f.events.onInputUp.add(this.check,this),this.activeImages.push(f)):(e.imgIndex=a,this.deathImages.push(e));this.uiframe=this.add.group(),this.uiframe.create(0,0,"header"),this.uiframe.create(0,491,"footer"),this.promtTextBg=this.uiframe.create(48,505,"prompt-times"),this.uiframe.fixedToCamera=!0,this.uiframe.add(this.add.button(14,503,"prompt",this.promptOnce,this)),this.uiframe.add(this.add.button(92,503,"add-time",this.addTime,this)),this.promptText=this.add.text(58,518,this.sconfig.fr,{font:"15px Arial",fill:"#ffffff"}),this.promptText.anchor.setTo(.5),g=this.add.text(133,518,"$",{font:"18px Arial",fill:"#ffffff"}),g.anchor.setTo(.5),this.uiframe.add(g),this.levelText=this.add.text(305,22,"",{font:"20px Arial",fill:"#ffffff"}),this.levelText.anchor.setTo(.5),this.taskText=this.add.text(20,22,"",{font:"20px Arial",fill:"#000000"}),this.taskText.anchor.setTo(0,.5),this.uiframe.add(this.promptText),this.uiframe.add(this.levelText),this.uiframe.add(this.taskText),this.timeText=this.add.text(300,503,this.getRTime(),{font:"21px Arial",fill:"#000000"}),this.remainTimer=d.time.events.loop(Phaser.Timer.SECOND,this.updateTime,this),this.uiframe.add(this.timeText),h=this,ajax({url:"/find/begin",data:{},onSuccess:function(a){var b=JSON.parse(a);0==b.code?(h.currentId=b.data.i,h.ready=!0,h.nextLevel()):ajaxError(b.code)}})},nextLevel:function(){var a,b,c,d;for(this.currentLevel++,this.found=[],a=this.rnd.integerInRange(0,this.activeImages.length-1),b=this.rnd.integerInRange(0,BasicGame.imageTags[this.activeImages[a].imgIndex].length-1),this.currentTag=BasicGame.imageTags[this.activeImages[a].imgIndex][b],c=0,i=0;i<this.activeImages.length;i++)inArray(this.currentTag,BasicGame.imageTags[this.activeImages[i].imgIndex])&&c++;d=this.math.floor(c/2),0==d&&(d=1),this.taskNum=this.rnd.integerInRange(d,c),this.taskNum>7&&(this.taskNum=7),this.levelText.setText("第 "+this.currentLevel+" 关"),this.taskText.setText(BasicGame.tags[this.currentTag]+" × "+this.taskNum)},findOne:function(a){if(this.found.push(a.imgIndex),this.add.tween(a).to({alpha:0},500,Phaser.Easing.Linear.None,!0).onComplete.add(function(){var d,e,b=null,c=!1;for(d=0;d<this.deathImages.length;d++)if(this.deathImages[d].w==a.width&&this.deathImages[d].h==a.height){if(inArray(this.currentTag,BasicGame.imageTags[this.deathImages[d].imgIndex])){b||(b=d);continue}c=!0,a.loadTexture("image"+this.deathImages[d].imgIndex),this.add.tween(a).to({alpha:1},500,Phaser.Easing.Linear.None,!0),e={w:a.width,h:a.height,imgIndex:a.imgIndex},a.imgIndex=this.deathImages[d].imgIndex,this.deathImages.splice(d,1),this.deathImages.push(e);break}c||null==b?c||this.add.tween(a).to({alpha:1},500,Phaser.Easing.Linear.None,!0):(a.loadTexture("image"+this.deathImages[b].imgIndex),this.add.tween(a).to({alpha:1},500,Phaser.Easing.Linear.None,!0),e={w:a.width,h:a.height,imgIndex:a.imgIndex},a.imgIndex=this.deathImages[b].imgIndex,this.deathImages.splice(b,1),this.deathImages.push(e))},this),this.found.length<this.taskNum)return this.taskText.setText(BasicGame.tags[this.currentTag]+" × "+(this.taskNum-this.found.length)),void 0;if(inArray(this.currentLevel,this.sconfig.prizeLevel)){var c=this;return ajax({url:"/find/finish",data:{i:this.currentId,level:this.currentLevel},onSuccess:function(a){var b=JSON.parse(a);0==b.code?(b.data&&b.data.points&&(userpoints+=parseInt(b.data.points),c.showPoints("+"+b.data.points,"#01A04C")),c.nextLevel()):ajaxError(b.code)}}),void 0}this.nextLevel()},showPoints:function(a,b){var c,e;b=b||"#E90B0C",c="#E90B0C"==b?this.add.text(180,180,a,{font:"bold 30px Arial",fill:b}):this.add.text(100,180,a,{font:"bold 30px Arial",fill:b}),c.anchor.setTo(.5),c.fixedToCamera=!0,e=d.add.tween(c.cameraOffset).to({y:30},1500,Phaser.Easing.Linear.None),e.onComplete.add(function(){c.destroy()}),e.start(),d.add.tween(c).to({alpha:0},500,Phaser.Easing.Linear.None,!0,1e3)},checkBegin:function(a){a.lastClick=d.time.now},check:function(a){return!this.ready||d.time.now-a.lastClick>400||inArray(a.imgIndex,this.found)?void 0:inArray(this.currentTag,BasicGame.imageTags[a.imgIndex])?(this.remainTime+=this.sconfig.at,this.findOne(a),void 0):(this.remainTime-=this.sconfig.st,void 0)},topHeadFoot:function(){d.world.bringToTop(this.header),d.world.bringToTop(this.footer)},getRTime:function(){return minutes=Math.floor(this.remainTime/60),seconds=this.remainTime%60,10>minutes&&(minutes="0"+minutes),10>seconds&&(seconds="0"+seconds),minutes+":"+seconds},updateTime:function(){var a,b;this.ready&&(this.remainTime--,this.remainTime<=0?(d.time.events.remove(this.remainTimer),this.timeText.setText("00:00"),this.ready=!1,a=!1,b=this,sweetAlert({title:"时间到！"},function(){a=!0,b.state.start("MainMenu")}),d.time.events.add(5*Phaser.Timer.SECOND,function(){a||this.state.start("MainMenu")},this).autoDestroy=!0):this.timeText.setText(this.getRTime()))},promptOnce:function(){var a,b;if(!(!this.ready||this.promptIng||this.found.length>=this.taskNum))if(this.promptTimes>=this.sconfig.fr+this.sconfig.mr)sweetAlert("每轮最多购买"+this.sconfig.mr+"次提醒");else if(this.promptTimes>=this.sconfig.fr){if(userpoints<this.sconfig.rp)return sweetAlert("您的积分不够"),void 0;this.promptIng=!0,a=this,ajax({url:"/find/prompt",data:{i:this.currentId},onSuccess:function(b){var c=JSON.parse(b);0==c.code?(userpoints-=a.sconfig.rp,a.showPoints("-"+a.sconfig.rp),a.doPrompt()):ajaxError(c.code)},onComplete:function(){a.promptIng=!1}})}else b=this.sconfig.fr-this.promptTimes-1,0>=b&&(this.promtTextBg.destroy(),b="$",this.promptText.setStyle({font:"18px Arial",fill:"#ffffff"})),this.promptText.setText(b),this.doPrompt()},doPrompt:function(){var b,a=this.rnd.integerInRange(0,this.activeImages.length-1);for(b=a;b<this.activeImages.length;b++)if(inArray(this.currentTag,BasicGame.imageTags[this.activeImages[b].imgIndex]))return this.promptTimes++,(this.activeImages[b].x>d.camera.x+360-this.activeImages[b].width||this.activeImages[b].x<d.camera.x)&&(d.camera.x=this.activeImages[b].x-this.rnd.integerInRange(0,360-this.activeImages[b].width)),this.findOne(this.activeImages[b]),void 0;if(a>0)for(b=0;a>b;b++)if(inArray(this.currentTag,BasicGame.imageTags[this.activeImages[b].imgIndex]))return this.promptTimes++,(this.activeImages[b].x>d.camera.x+360-this.activeImages[b].width||this.activeImages[b].x<d.camera.x)&&(d.camera.x=this.activeImages[b].x-this.rnd.integerInRange(0,360-this.activeImages[b].width)),this.findOne(this.activeImages[b]),void 0},addTime:function(){if(this.ready&&!this.addTimeIng)if(this.addtTimes>=this.sconfig.mt)sweetAlert("每轮最多加时"+this.sconfig.mt+"次");else{if(userpoints<this.sconfig.t)return sweetAlert("您的积分不够"),void 0;this.addTimeIng=!0;var a=this;ajax({url:"/find/timer",data:{i:this.currentId},onSuccess:function(b){var c=JSON.parse(b);0==c.code?(userpoints-=a.sconfig.tp,a.remainTime+=a.sconfig.t,a.showPoints("-"+a.sconfig.tp),a.addtTimes++):ajaxError(c.code)},onComplete:function(){a.addTimeIng=!1}})}},update:function(){this.ready&&d.input.activePointer.isDown&&(d.camera.x+=this.scrollX-d.input.activePointer.x,this.scrollX=d.input.activePointer.x)},beginScroll:function(){this.scrollX=d.input.activePointer.x}},d.state.add("Boot",BasicGame.Boot),d.state.add("Preloader",BasicGame.Preloader),d.state.add("MainMenu",BasicGame.MainMenu),d.state.add("Game",BasicGame.Game),d.state.start("Boot")}();